name: CI/CD

on:
  push:
    branches:
      - master
      - main
    tags:
      - 'v*.*.*'
      - '*.*.*'
  pull_request:
    branches:
      - master
      - main

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore FastDFS.Client.sln

      - name: Build solution
        run: dotnet build FastDFS.Client.sln --configuration Release --no-restore

      - name: Run tests
        run: dotnet test FastDFS.Client.sln --configuration Release --no-build --verbosity normal --logger trx --results-directory ./TestResults

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: ./TestResults/*.trx

  package:
    name: Create NuGet Packages
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Extract version from tag
        id: get_version
        run: |
          # Remove 'v' prefix if present (v1.0.0 -> 1.0.0)
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Package version: $VERSION"

      - name: Restore dependencies
        run: dotnet restore FastDFS.Client.sln

      - name: Build solution
        run: dotnet build FastDFS.Client.sln --configuration Release --no-restore

      - name: Pack FastDFS.Client
        run: dotnet pack src/FastDFS.Client/FastDFS.Client.csproj --configuration Release --no-build --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.VERSION }}

      - name: Pack FastDFS.Client.DependencyInjection
        run: dotnet pack src/FastDFS.Client.DependencyInjection/FastDFS.Client.DependencyInjection.csproj --configuration Release --no-build --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.VERSION }}

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: ./artifacts/*.nupkg

  publish:
    name: Publish to NuGet
    runs-on: ubuntu-latest
    needs: package
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download packages
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: ./artifacts

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        id: release_notes
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "^${GITHUB_REF#refs/tags/}$" | head -n 1)

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found, using all commits"
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi

          echo "Generating release notes from $PREVIOUS_TAG to ${GITHUB_REF#refs/tags/}"

          # Generate changelog with categorized commits
          {
            echo "## ðŸ“¦ FastDFS .NET Client ${{ steps.get_version.outputs.VERSION }}"
            echo ""
            echo "### What's Changed"
            echo ""

            # Features
            FEATURES=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"%s" --no-merges | grep -E "^feat(\(.*\))?:" || true)
            if [ ! -z "$FEATURES" ]; then
              echo "#### âœ¨ Features"
              echo "$FEATURES" | sed 's/^feat/- /' | sed 's/^- (\(.*\)):/- **\1:**/'
              echo ""
            fi

            # Bug Fixes
            FIXES=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"%s" --no-merges | grep -E "^fix(\(.*\))?:" || true)
            if [ ! -z "$FIXES" ]; then
              echo "#### ðŸ› Bug Fixes"
              echo "$FIXES" | sed 's/^fix/- /' | sed 's/^- (\(.*\)):/- **\1:**/'
              echo ""
            fi

            # Performance Improvements
            PERF=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"%s" --no-merges | grep -E "^perf(\(.*\))?:" || true)
            if [ ! -z "$PERF" ]; then
              echo "#### âš¡ Performance Improvements"
              echo "$PERF" | sed 's/^perf/- /' | sed 's/^- (\(.*\)):/- **\1:**/'
              echo ""
            fi

            # Documentation
            DOCS=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"%s" --no-merges | grep -E "^docs(\(.*\))?:" || true)
            if [ ! -z "$DOCS" ]; then
              echo "#### ðŸ“š Documentation"
              echo "$DOCS" | sed 's/^docs/- /' | sed 's/^- (\(.*\)):/- **\1:**/'
              echo ""
            fi

            # Build & CI/CD
            BUILD=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"%s" --no-merges | grep -E "^(build|ci)(\(.*\))?:" || true)
            if [ ! -z "$BUILD" ]; then
              echo "#### ðŸ”§ Build & CI/CD"
              echo "$BUILD" | sed 's/^build/- /' | sed 's/^ci/- /' | sed 's/^- (\(.*\)):/- **\1:**/'
              echo ""
            fi

            # Refactoring
            REFACTOR=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"%s" --no-merges | grep -E "^refactor(\(.*\))?:" || true)
            if [ ! -z "$REFACTOR" ]; then
              echo "#### â™»ï¸ Code Refactoring"
              echo "$REFACTOR" | sed 's/^refactor/- /' | sed 's/^- (\(.*\)):/- **\1:**/'
              echo ""
            fi

            # Tests
            TESTS=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"%s" --no-merges | grep -E "^test(\(.*\))?:" || true)
            if [ ! -z "$TESTS" ]; then
              echo "#### ðŸ§ª Tests"
              echo "$TESTS" | sed 's/^test/- /' | sed 's/^- (\(.*\)):/- **\1:**/'
              echo ""
            fi

            # Other changes
            OTHER=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"%s" --no-merges | grep -vE "^(feat|fix|docs|style|refactor|perf|test|build|ci)(\(.*\))?:" || true)
            if [ ! -z "$OTHER" ]; then
              echo "#### ðŸ”€ Other Changes"
              echo "$OTHER" | sed 's/^/- /'
              echo ""
            fi

            # Contributors
            echo "### ðŸ‘¥ Contributors"
            git log $PREVIOUS_TAG..HEAD --pretty=format:"%an" --no-merges | sort -u | sed 's/^/- @/' | sed 's/@Claude Sonnet 4.5/ðŸ¤– Claude Sonnet 4.5/'
            echo ""

            # Installation
            echo "### ðŸ“¥ Installation"
            echo ""
            echo "\`\`\`bash"
            echo "dotnet add package FastDFS.Client --version ${{ steps.get_version.outputs.VERSION }}"
            echo "dotnet add package FastDFS.Client.DependencyInjection --version ${{ steps.get_version.outputs.VERSION }}"
            echo "\`\`\`"
            echo ""

            # Links
            echo "### ðŸ”— Links"
            echo "- [NuGet Package - FastDFS.Client](https://www.nuget.org/packages/FastDFS.Client/${{ steps.get_version.outputs.VERSION }})"
            echo "- [NuGet Package - FastDFS.Client.DependencyInjection](https://www.nuget.org/packages/FastDFS.Client.DependencyInjection/${{ steps.get_version.outputs.VERSION }})"
            echo "- [Full Changelog](https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG...${{ steps.get_version.outputs.TAG_NAME }})"

          } > release_notes.md

          # Output for GitHub Actions
          echo "PREVIOUS_TAG=$PREVIOUS_TAG" >> $GITHUB_OUTPUT

          cat release_notes.md

      - name: Publish to NuGet
        run: |
          for package in ./artifacts/*.nupkg
          do
            echo "Publishing $package"
            dotnet nuget push "$package" --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./artifacts/*.nupkg
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
